<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Book Log</title>
  <style>
    :root{
      --bg:#0b1020; --muted:#9fb0ff; --text:#eef2ff; --danger:#ff6b6b; --ok:#26d07c; --border:rgba(255,255,255,.12);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,"Noto Sans Thai",sans-serif;
      background:radial-gradient(1200px 800px at 20% 0%, rgba(122,162,255,.25), transparent 60%),
                 radial-gradient(1000px 700px at 90% 20%, rgba(38,208,124,.18), transparent 55%),
                 var(--bg);
      color:var(--text);
      padding:24px;
    }
    .container{max-width:1120px;margin:0 auto}
    .row{display:grid;grid-template-columns:1fr 1.15fr;gap:16px}
    @media (max-width:980px){.row{grid-template-columns:1fr}}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--border);
      border-radius:16px;
      padding:16px;
      box-shadow:0 12px 28px rgba(0,0,0,.35);
      backdrop-filter:blur(6px);
    }
    h1{font-size:22px;margin:0 0 10px}
    h2{font-size:18px;margin:0 0 10px}
    label{display:block;font-size:13px;color:rgba(238,242,255,.8);margin-bottom:6px}
    input[type="text"], textarea, select{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
    }
    textarea{min-height:92px;resize:vertical}
    .btn{
      border:1px solid var(--border);
      background:rgba(122,162,255,.16);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:700;
      white-space:nowrap;
    }
    .btn:hover{background:rgba(122,162,255,.26)}
    .btn.secondary{background:rgba(255,255,255,.06)}
    .btn.secondary:hover{background:rgba(255,255,255,.12)}
    .btn.danger{background:rgba(255,107,107,.18)}
    .btn.danger:hover{background:rgba(255,107,107,.28)}
    .btn.ok{background:rgba(38,208,124,.16)}
    .btn.ok:hover{background:rgba(38,208,124,.26)}
    .inline{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .muted{color:rgba(238,242,255,.7);font-size:13px}
    .msg{margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid var(--border)}
    .msg.ok{background:rgba(38,208,124,.12)}
    .msg.err{background:rgba(255,107,107,.12)}
    .divider{height:1px;background:var(--border);margin:12px 0}
    .stars{display:inline-flex;gap:6px;user-select:none}
    .star{
      font-size:22px;line-height:1;cursor:pointer;
      filter:drop-shadow(0 2px 10px rgba(0,0,0,.25));
      opacity:.55;transition:transform .05s ease, opacity .1s ease;
    }
    .star.active{opacity:1}
    .star:hover{transform:scale(1.06);opacity:.9}

    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 10px;border-bottom:1px solid var(--border);vertical-align:top}
    th{
      text-align:left;font-size:13px;color:rgba(238,242,255,.75);
      position:sticky;top:0;background:rgba(11,16,32,.65);backdrop-filter:blur(6px);
    }
    td{font-size:14px}
    .pill{
      display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;
      border:1px solid var(--border);background:rgba(0,0,0,.16);font-size:12px;color:rgba(238,242,255,.82);
    }
    .pill.ok{border-color:rgba(38,208,124,.35);background:rgba(38,208,124,.10)}
    .pill.todo{border-color:rgba(255,255,255,.18)}
    .right{text-align:right}
    .small{font-size:12px;color:rgba(238,242,255,.72)}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:560px){.grid2{grid-template-columns:1fr}}
    #scannerWrap{display:none}
    #reader{
      width:100%;border-radius:14px;overflow:hidden;border:1px solid var(--border);
      background:rgba(0,0,0,.18);padding:10px;
    }
    .cover-preview{
      width:56px;height:72px;border-radius:10px;border:1px solid var(--border);
      background:rgba(0,0,0,.18);object-fit:cover;display:block;
    }
    .topbar{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap}
    .langbox{display:flex;gap:8px;align-items:center}
    .langbox select{width:auto;min-width:160px}
  
    /* Responsive list: turn table into cards on small screens */
    @media (max-width: 760px){
      table, thead, tbody, th, td, tr { display: block; }
      thead { display: none; }
      tbody tr{
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 10px;
        margin-bottom: 10px;
        background: rgba(0,0,0,.10);
      }
      tbody td{
        border: none;
        padding: 8px 8px;
        display: grid;
        grid-template-columns: 120px 1fr;
        gap: 10px;
        align-items: start;
      }
      tbody td::before{
        content: attr(data-label);
        font-weight: 700;
        font-size: 12px;
        color: rgba(238,242,255,.78);
      }
      tbody td.right{ text-align: left; }
      .cover-preview{ width: 64px; height: 84px; }
    }

  </style>
</head>

<body>
  <div class="container">

    <!-- PAGE 1: LOGIN -->
    <div id="pageLogin" class="card">
      <div class="topbar">
        <div>
          <h1 id="ui_appTitle_login">üìö ‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏ã‡∏∑‡πâ‡∏≠</h1>
          <p class="muted" id="ui_loginSubtitle">
            ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Username ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ)
            <br>‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: Username ‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏≤‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 4 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏ç‡πà A‚ÄìZ ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ï‡∏±‡∏ß
          </p>
        </div>

        <div class="langbox">
          <label for="langSelectLogin" class="muted" style="margin:0" id="ui_languageLabel_login">‡∏†‡∏≤‡∏©‡∏≤</label>
          <select id="langSelectLogin">
            <option value="th">‡πÑ‡∏ó‡∏¢</option>
            <option value="en-US">English (US)</option>
          </select>
        </div>
      </div>

      <div>
        <label for="username" id="ui_usernameLabel_login">Username</label>
        <input id="username" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô CakeChocco (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 4 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ ‡πÅ‡∏•‡∏∞‡∏°‡∏µ A‚ÄìZ ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ï‡∏±‡∏ß)" />
      </div>

      <div class="inline" style="margin-top:12px;">
        <button class="btn" id="btnLogin">Log in</button>
      </div>

      

      <div class="msg ok" id="accessNote" style="margin-top:12px;">
        ‚úÖ ‡∏´‡∏≤‡∏Å‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡∏ö‡∏ô‡πÄ‡∏ß‡πá‡∏ö (https://) ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏î‡∏Å‡πá‡πÑ‡∏î‡πâ (‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠/‡πÅ‡∏ó‡πá‡∏ö‡πÄ‡∏•‡πá‡∏ï/‡∏Ñ‡∏≠‡∏°) ‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏à‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
      </div>

<div id="loginMsg"></div>
    </div>

    <!-- PAGE 2: APP -->
    <div id="pageApp" style="display:none;">
      <div class="inline" style="justify-content: space-between; margin: 18px 0 10px;">
        <h1 style="margin:0;" id="ui_appHeader">üìù ‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</h1>
        <div class="inline">
          <div class="langbox">
            <label for="langSelectApp" class="muted" style="margin:0" id="ui_languageLabel_app">‡∏†‡∏≤‡∏©‡∏≤</label>
            <select id="langSelectApp">
              <option value="th">‡πÑ‡∏ó‡∏¢</option>
              <option value="en-US">English (US)</option>
            </select>
          </div>
          <span class="pill" id="ui_userPill">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: <b id="who"></b></span>
          <button class="btn secondary" id="btnLogout">Log out</button>
        </div>
      </div>

      <div class="row">
        <!-- LEFT: Form -->
        <div class="card">
          <h2 id="ui_formTitle">‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</h2>
          <div class="inline" style="justify-content: space-between;">
            <div class="pill" id="ui_scanPill">‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î/ISBN ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡∏¥‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>
            <div class="inline">
              <button class="btn secondary" id="btnStartScan">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô</button>
              <button class="btn danger" id="btnStopScan" style="display:none;">‡∏´‡∏¢‡∏∏‡∏î‡∏™‡πÅ‡∏Å‡∏ô</button>
            </div>
          </div>

          <div id="scannerWrap" style="margin-top: 10px;">
            <div id="reader"></div>
            <div class="small" style="margin-top:8px;" id="ui_cameraHint">
              * ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏î‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô <b>https://</b> ‡∏´‡∏£‡∏∑‡∏≠ <b>localhost</b>
            </div>
          </div>

          <div class="divider"></div>

          <div class="grid2">
            <div>
              <label for="bookTitle" id="ui_bookTitleLabel">‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</label>
              <input id="bookTitle" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô Pharmacotherapy Handbook" />
            </div>
            <div>
              <label for="bookAuthor" id="ui_bookAuthorLabel">‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô</label>
              <input id="bookAuthor" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô Wells, Dipiro, Schwinghammer" />
            </div>
          </div>

          <div class="grid2" style="margin-top: 12px;">
            <div>
              <label id="ui_readStatusLabel">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô</label>
              <div class="inline">
                <input id="readAlready" type="checkbox" />
                <label for="readAlready" style="margin:0;" id="ui_readAlreadyCheckbox">‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</label>
              </div>
              <div class="small" id="ui_unreadRule">‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡πà‡∏≤‡∏ô: ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô</div>
            </div>
            <div>
              <label id="ui_ratingLabel">‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (‡πÄ‡∏ï‡πá‡∏° 5 ‡∏î‡∏≤‡∏ß)</label>
              <div class="inline">
                <div id="starBar" class="stars" aria-label="star rating"></div>
                <span class="pill" id="starValue">0/5</span>
              </div>
              <div class="small" id="ratingHint"></div>
            </div>
          </div>

          <div style="margin-top: 12px;">
            <label for="comment" id="ui_commentLabel">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏ï‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</label>
            <textarea id="comment" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô..."></textarea>
          </div>

          <div style="margin-top: 12px;">
            <label for="coverFile" id="ui_coverLabel">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏õ‡∏Å (jpg/png/webp)</label>
            <input id="coverFile" type="file" accept="image/*" />
            <div class="inline" style="margin-top:10px;">
              <img id="coverPreview" class="cover-preview" alt="cover preview" />
              <div class="muted" id="ui_coverHint">‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏£‡∏π‡∏õ‡∏õ‡∏Å (‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏õ‡∏Å‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</div>
              <button class="btn secondary" id="btnRemoveCover" type="button">‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏õ‡∏Å</button>
            </div>
          </div>

          <div class="inline" style="margin-top: 14px;">
            <button class="btn ok" id="btnSave">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            <button class="btn secondary" id="btnClear">‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
            <span class="pill" id="modePill">‡πÇ‡∏´‡∏°‡∏î: <b>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</b></span>
          </div>

          <div id="saveMsg"></div>
        </div>

        <!-- RIGHT: Summary + Search/Filter + List -->
        <div class="card">
          <h2 id="ui_listTitle">‡∏™‡∏£‡∏∏‡∏õ & ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß</h2>

          <div class="inline" style="gap:8px; margin-bottom: 12px;">
            <span class="pill" id="ui_totalPill">üì¶ ‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <b id="sumTotal">0</b></span>
            <span class="pill ok" id="ui_readPill">‚úÖ ‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß: <b id="sumRead">0</b></span>
            <span class="pill todo" id="ui_unreadPill">üïí ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡πà‡∏≤‡∏ô: <b id="sumUnread">0</b></span>
          </div>

          <div class="grid2" style="margin-bottom: 10px;">
            <div>
              <label for="searchBox" id="ui_searchLabel">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠/‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô)</label>
              <input id="searchBox" type="text" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." />
            </div>
            <div>
              <label for="statusFilter" id="ui_filterLabel">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
              <select id="statusFilter">
                <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                <option value="read">‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</option>
                <option value="unread">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡πà‡∏≤‡∏ô</option>
              </select>
            </div>
          </div>

          <div class="inline" style="justify-content: space-between; margin-bottom: 10px;">
            <div class="inline">
              <button class="btn" id="btnExportXlsx">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô Excel (.xlsx)</button>
              <button class="btn secondary" id="btnExportCsv">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô CSV</button>
            </div>
            <button class="btn danger" id="btnWipeAll">‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
          </div>

          <div class="muted" style="margin-bottom: 10px;" id="ui_storageHint">
            ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (localStorage) ‡∏Ç‡∏≠‡∏á‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå ‡πÅ‡∏•‡∏∞‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
          </div>

          <div style="overflow:auto; max-height: 520px;">
            <table>
              <thead>
                <tr>
                  <th id="ui_th_cover">‡∏£‡∏π‡∏õ</th>
                  <th id="ui_th_title">‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠</th>
                  <th id="ui_th_author">‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô</th>
                  <th id="ui_th_status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                  <th id="ui_th_rating">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th>
                  <th id="ui_th_comment">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô</th>
                  <th class="right" id="ui_th_actions">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                </tr>
              </thead>
              <tbody id="bookTable"></tbody>
            </table>
          </div>

        </div>
      </div>
    </div>

  </div>

  <!-- Libraries -->
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    // ====== I18N ======
    const LANG_KEY = "book_log_lang_v1";
    const I18N = {
      "th": {
        docTitle: "‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏ã‡∏∑‡πâ‡∏≠",
        appTitleLogin: "üìö ‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏ã‡∏∑‡πâ‡∏≠",
        loginSubtitle: "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Username ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ)\n‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: Username ‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏≤‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 4 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏ç‡πà A‚ÄìZ ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ï‡∏±‡∏ß",
        languageLabel: "‡∏†‡∏≤‡∏©‡∏≤",
        usernameLabel: "Username",
        usernamePh: "‡πÄ‡∏ä‡πà‡∏ô CakeChocco (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 4 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ ‡πÅ‡∏•‡∏∞‡∏°‡∏µ A‚ÄìZ ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ï‡∏±‡∏ß)",
        loginBtn: "Log in",
        logoutBtn: "Log out",

        appHeader: "üìù ‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠",
        userPill: "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:",
        formTitle: "‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠",
        scanPill: "‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î/ISBN ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡∏¥‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥",
        startScan: "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πÅ‡∏Å‡∏ô",
        stopScan: "‡∏´‡∏¢‡∏∏‡∏î‡∏™‡πÅ‡∏Å‡∏ô",
        cameraHint: "* ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏î‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô https:// ‡∏´‡∏£‡∏∑‡∏≠ localhost",

        bookTitleLabel: "‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠",
        bookTitlePh: "‡πÄ‡∏ä‡πà‡∏ô Pharmacotherapy Handbook",
        bookAuthorLabel: "‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô",
        bookAuthorPh: "‡πÄ‡∏ä‡πà‡∏ô Wells, Dipiro, Schwinghammer",

        readStatusLabel: "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô",
        readAlready: "‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß",
        unreadRule: "‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡πà‡∏≤‡∏ô: ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô",

        ratingLabel: "‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (‡πÄ‡∏ï‡πá‡∏° 5 ‡∏î‡∏≤‡∏ß)",
        ratingHintUnread: "* ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠ ‚Äú‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß‚Äù ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô",
        commentLabel: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏ï‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠",
        commentPhRead: "‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô...",
        commentPhUnread: "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡πà‡∏≤‡∏ô (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô)",

        coverLabel: "‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏õ‡∏Å (jpg/png/webp)",
        coverHint: "‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏£‡∏π‡∏õ‡∏õ‡∏Å (‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏õ‡∏Å‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)",
        removeCover: "‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏õ‡∏Å",

        save: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å",
        update: "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï",
        clearForm: "‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°",
        modeAdd: "‡πÇ‡∏´‡∏°‡∏î: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà",
        modeEdit: "‡πÇ‡∏´‡∏°‡∏î: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç",

        listTitle: "‡∏™‡∏£‡∏∏‡∏õ & ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß",
        totalPill: "üì¶ ‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:",
        readPill: "‚úÖ ‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß:",
        unreadPill: "üïí ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡πà‡∏≤‡∏ô:",

        searchLabel: "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠/‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô)",
        searchPh: "‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...",
        filterLabel: "‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞",
        filterAll: "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î",
        filterRead: "‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß",
        filterUnread: "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡πà‡∏≤‡∏ô",

        exportXlsx: "‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô Excel (.xlsx)",
        exportCsv: "‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô CSV",
        wipeAll: "‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î",
        storageHint: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (localStorage) ‡∏Ç‡∏≠‡∏á‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå ‡πÅ‡∏•‡∏∞‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ",

        thCover: "‡∏£‡∏π‡∏õ",
        thTitle: "‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠",
        thAuthor: "‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô",
        thStatus: "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞",
        thRating: "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô",
        thComment: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô",
        thActions: "‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£",

        statusRead: "‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß",
        statusUnread: "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡πà‡∏≤‡∏ô",
        noCover: "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ",
        isbn: "ISBN:",
        created: "‡πÄ‡∏û‡∏¥‡πà‡∏°:",
        updated: "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:",
        noResults: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏•‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á/‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤)",

        actionEdit: "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç",
        actionToggle: "‡∏™‡∏•‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞",
        actionDelete: "‡∏•‡∏ö",

        ratingNA: "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô",
        dash: "‚Äî",

        // messages
        errNeedUsername: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Username",
        errUsernameRule: "Username ‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏≤‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 4 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏ç‡πà (A‚ÄìZ) ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ï‡∏±‡∏ß",
        msgLoggedOut: "‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß",
        errNeedTitleAuthor: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö",
        errNeedRatingRead: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏î‡∏≤‡∏ß (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß)",
        errEditNotFound: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡∏≠‡∏≤‡∏à‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß)",
        msgUpdated: "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚úÖ",
        msgSaved: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚úÖ",

        confirmWipe: "‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ \"{user}\" ‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?",
        errNoExportData: "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å",
        msgExportXlsxOk: "‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel ‡πÅ‡∏•‡πâ‡∏ß ‚úÖ",
        msgExportCsvOk: "‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV ‡πÅ‡∏•‡πâ‡∏ß ‚úÖ",

        errCoverTooBig: "‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô ~800KB",
        msgCoverUploaded: "‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏õ‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚úÖ",

        scanGot: "‡∏™‡πÅ‡∏Å‡∏ô‡πÑ‡∏î‡πâ: {code} ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...",
        scanNotFound: "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏•‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏´‡∏°‡πà)",
        scanFilled: "‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß ‚úÖ (ISBN: {isbn})",
        scanFetchErr: "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ (‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï)",

        camNotFound: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏ö‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ",
        camNoPermission: "‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ https ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏•‡πâ‡∏≠‡∏á)",
        scanning: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πÅ‡∏Å‡∏ô... ‡πÄ‡∏≠‡∏≤‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠/‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ü‡∏£‡∏°"
      },

      "en-US": {
        docTitle: "Book Purchase Log",
        appTitleLogin: "üìö Book Purchase Log",
        loginSubtitle: "Sign in with username only (data is separated per user).\nRules: Username must be at least 4 characters and include at least one uppercase letter (A‚ÄìZ).",
        languageLabel: "Language",
        usernameLabel: "Username",
        usernamePh: "e.g., CakeChocco (min 4 chars + at least 1 uppercase A‚ÄìZ)",
        loginBtn: "Log in",
        logoutBtn: "Log out",

        appHeader: "üìù Book Entry",
        userPill: "User:",
        formTitle: "Add / Edit a book",
        scanPill: "Scan a barcode/ISBN to auto-fill title and author",
        startScan: "Start scan",
        stopScan: "Stop scan",
        cameraHint: "* Camera works best on https:// or localhost",

        bookTitleLabel: "Book title",
        bookTitlePh: "e.g., Pharmacotherapy Handbook",
        bookAuthorLabel: "Author",
        bookAuthorPh: "e.g., Wells, Dipiro, Schwinghammer",

        readStatusLabel: "Reading status",
        readAlready: "Read",
        unreadRule: "If unread: no rating or review required",

        ratingLabel: "Rating (max 5 stars)",
        ratingHintUnread: "* Rating is available only when marked as ‚ÄúRead‚Äù",
        commentLabel: "Review",
        commentPhRead: "Type your review...",
        commentPhUnread: "Unread (no review needed)",

        coverLabel: "Upload cover image (jpg/png/webp)",
        coverHint: "Cover preview (saved with the entry)",
        removeCover: "Remove cover",

        save: "Save",
        update: "Update",
        clearForm: "Clear form",
        modeAdd: "Mode: Add new",
        modeEdit: "Mode: Edit",

        listTitle: "Summary & Saved books",
        totalPill: "üì¶ Total:",
        readPill: "‚úÖ Read:",
        unreadPill: "üïí Unread:",

        searchLabel: "Search (title/author/review)",
        searchPh: "Type to search...",
        filterLabel: "Filter by status",
        filterAll: "All",
        filterRead: "Read",
        filterUnread: "Unread",

        exportXlsx: "Export Excel (.xlsx)",
        exportCsv: "Export CSV",
        wipeAll: "Delete all data",
        storageHint: "Data is stored locally (localStorage) and separated per user",

        thCover: "Cover",
        thTitle: "Title",
        thAuthor: "Author",
        thStatus: "Status",
        thRating: "Rating",
        thComment: "Review",
        thActions: "Actions",

        statusRead: "Read",
        statusUnread: "Unread",
        noCover: "No cover",
        isbn: "ISBN:",
        created: "Added:",
        updated: "Updated:",
        noResults: "No items found (try changing the filter/search).",

        actionEdit: "Edit",
        actionToggle: "Toggle",
        actionDelete: "Delete",

        ratingNA: "Not rated",
        dash: "‚Äî",

        // messages
        errNeedUsername: "Please enter a username.",
        errUsernameRule: "Username must be at least 4 characters and include at least one uppercase letter (A‚ÄìZ).",
        msgLoggedOut: "Logged out.",
        errNeedTitleAuthor: "Please fill in both book title and author.",
        errNeedRatingRead: "Please give at least 1 star (only for books marked as Read).",
        errEditNotFound: "Item to edit was not found (it may have been deleted).",
        msgUpdated: "Updated successfully ‚úÖ",
        msgSaved: "Saved successfully ‚úÖ",

        confirmWipe: "Delete all data for user \"{user}\"?",
        errNoExportData: "No data to export.",
        msgExportXlsxOk: "Excel exported ‚úÖ",
        msgExportCsvOk: "CSV exported ‚úÖ",

        errCoverTooBig: "Cover image is too large. Recommended ‚â§ ~800KB.",
        msgCoverUploaded: "Cover uploaded ‚úÖ",

        scanGot: "Scanned: {code} ‚Äî looking up book info...",
        scanNotFound: "No book info found (you can type it manually or scan again).",
        scanFilled: "Auto-filled ‚úÖ (ISBN: {isbn})",
        scanFetchErr: "Failed to fetch book info (check your internet).",

        camNotFound: "No camera found on this device.",
        camNoPermission: "Unable to open camera (use https or allow camera permission).",
        scanning: "Scanning... Align the barcode/ISBN in the frame."
      }
    };

    function getSavedLang(){
      const v = localStorage.getItem(LANG_KEY);
      return (v === "en-US" || v === "th") ? v : "th";
    }
    let currentLang = getSavedLang();

    function tf(key, vars = {}){
      const dict = I18N[currentLang] || I18N.th;
      let s = (dict[key] ?? I18N.th[key] ?? key).toString();
      for(const [k,v] of Object.entries(vars)){
        s = s.replaceAll(`{${k}}`, String(v));
      }
      return s;
    }

    function setLang(lang){
      currentLang = (lang === "en-US") ? "en-US" : "th";
      localStorage.setItem(LANG_KEY, currentLang);

      // update html lang attr
      document.documentElement.lang = (currentLang === "en-US") ? "en" : "th";
      document.title = tf("docTitle");

      // sync selectors
      langSelectLogin.value = currentLang;
      langSelectApp.value = currentLang;

      // login UI
      ui_appTitle_login.textContent = tf("appTitleLogin");
      ui_loginSubtitle.innerHTML = tf("loginSubtitle").replaceAll("\n", "<br>");
      ui_languageLabel_login.textContent = tf("languageLabel");
      ui_usernameLabel_login.textContent = tf("usernameLabel");
      username.placeholder = tf("usernamePh");
      btnLogin.textContent = tf("loginBtn");

      // app header UI
      ui_appHeader.textContent = tf("appHeader");
      ui_languageLabel_app.textContent = tf("languageLabel");
      ui_userPill.firstChild.textContent = tf("userPill") + " ";
      btnLogout.textContent = tf("logoutBtn");

      // form UI
      ui_formTitle.textContent = tf("formTitle");
      ui_scanPill.textContent = tf("scanPill");
      btnStartScan.textContent = tf("startScan");
      btnStopScan.textContent = tf("stopScan");
      ui_cameraHint.innerHTML = tf("cameraHint").replaceAll("https://", "<b>https://</b>").replaceAll("localhost", "<b>localhost</b>");

      ui_bookTitleLabel.textContent = tf("bookTitleLabel");
      bookTitle.placeholder = tf("bookTitlePh");
      ui_bookAuthorLabel.textContent = tf("bookAuthorLabel");
      bookAuthor.placeholder = tf("bookAuthorPh");

      ui_readStatusLabel.textContent = tf("readStatusLabel");
      ui_readAlreadyCheckbox.textContent = tf("readAlready");
      ui_unreadRule.textContent = tf("unreadRule");
      ui_ratingLabel.textContent = tf("ratingLabel");
      ui_commentLabel.textContent = tf("commentLabel");

      ui_coverLabel.textContent = tf("coverLabel");
      ui_coverHint.textContent = tf("coverHint");
      btnRemoveCover.textContent = tf("removeCover");

      btnClear.textContent = tf("clearForm");

      // list UI
      ui_listTitle.textContent = tf("listTitle");
      ui_totalPill.childNodes[0].textContent = tf("totalPill") + " ";
      ui_readPill.childNodes[0].textContent = tf("readPill") + " ";
      ui_unreadPill.childNodes[0].textContent = tf("unreadPill") + " ";

      ui_searchLabel.textContent = tf("searchLabel");
      searchBox.placeholder = tf("searchPh");
      ui_filterLabel.textContent = tf("filterLabel");

      // filter options
      statusFilter.querySelector('option[value="all"]').textContent = tf("filterAll");
      statusFilter.querySelector('option[value="read"]').textContent = tf("filterRead");
      statusFilter.querySelector('option[value="unread"]').textContent = tf("filterUnread");

      btnExportXlsx.textContent = tf("exportXlsx");
      btnExportCsv.textContent = tf("exportCsv");
      btnWipeAll.textContent = tf("wipeAll");
      ui_storageHint.textContent = tf("storageHint");

      // table headers
      ui_th_cover.textContent = tf("thCover");
      ui_th_title.textContent = tf("thTitle");
      ui_th_author.textContent = tf("thAuthor");
      ui_th_status.textContent = tf("thStatus");
      ui_th_rating.textContent = tf("thRating");
      ui_th_comment.textContent = tf("thComment");
      ui_th_actions.textContent = tf("thActions");

      // mode + save/update button text based on state
      refreshModePillAndSaveBtn();

      // unread/read UI sync
      syncReadStateUI();

      // rerender list to translate table/action buttons
      renderTable();
    }

    // ====== CONFIG ======
    const STORAGE_PREFIX = "book_log_items_user_v1:"; // per-user key prefix

    // ====== STATE ======
    let currentUser = null;
    let rating = 0;             // 0..5
    let html5Qr = null;
    let scanning = false;

    // edit mode
    let editId = null;          // string id or null
    let currentCoverDataUrl = null; // base64 image dataURL or null

    // ====== ELEMENTS ======
    const pageLogin = document.getElementById("pageLogin");
    const pageApp = document.getElementById("pageApp");
    const loginMsg = document.getElementById("loginMsg");

    const who = document.getElementById("who");
    const btnLogin = document.getElementById("btnLogin");
    const btnLogout = document.getElementById("btnLogout");

    const username = document.getElementById("username");

    const bookTitle = document.getElementById("bookTitle");
    const bookAuthor = document.getElementById("bookAuthor");
    const readAlready = document.getElementById("readAlready");
    const comment = document.getElementById("comment");

    const starBar = document.getElementById("starBar");
    const starValue = document.getElementById("starValue");
    const ratingHint = document.getElementById("ratingHint");

    const btnSave = document.getElementById("btnSave");
    const btnClear = document.getElementById("btnClear");
    const saveMsg = document.getElementById("saveMsg");
    const modePill = document.getElementById("modePill");

    const sumTotal = document.getElementById("sumTotal");
    const sumRead = document.getElementById("sumRead");
    const sumUnread = document.getElementById("sumUnread");

    const bookTable = document.getElementById("bookTable");
    const btnWipeAll = document.getElementById("btnWipeAll");

    const scannerWrap = document.getElementById("scannerWrap");
    const btnStartScan = document.getElementById("btnStartScan");
    const btnStopScan = document.getElementById("btnStopScan");

    const searchBox = document.getElementById("searchBox");
    const statusFilter = document.getElementById("statusFilter");

    const coverFile = document.getElementById("coverFile");
    const coverPreview = document.getElementById("coverPreview");
    const btnRemoveCover = document.getElementById("btnRemoveCover");

    const btnExportXlsx = document.getElementById("btnExportXlsx");
    const btnExportCsv = document.getElementById("btnExportCsv");

    // lang selectors
    const langSelectLogin = document.getElementById("langSelectLogin");
    const langSelectApp = document.getElementById("langSelectApp");

    // ui label nodes
    const ui_appTitle_login = document.getElementById("ui_appTitle_login");
    const ui_loginSubtitle = document.getElementById("ui_loginSubtitle");
    const ui_languageLabel_login = document.getElementById("ui_languageLabel_login");
    const ui_usernameLabel_login = document.getElementById("ui_usernameLabel_login");

    const ui_appHeader = document.getElementById("ui_appHeader");
    const ui_languageLabel_app = document.getElementById("ui_languageLabel_app");
    const ui_userPill = document.getElementById("ui_userPill");

    const ui_formTitle = document.getElementById("ui_formTitle");
    const ui_scanPill = document.getElementById("ui_scanPill");
    const ui_cameraHint = document.getElementById("ui_cameraHint");

    const ui_bookTitleLabel = document.getElementById("ui_bookTitleLabel");
    const ui_bookAuthorLabel = document.getElementById("ui_bookAuthorLabel");

    const ui_readStatusLabel = document.getElementById("ui_readStatusLabel");
    const ui_readAlreadyCheckbox = document.getElementById("ui_readAlreadyCheckbox");
    const ui_unreadRule = document.getElementById("ui_unreadRule");
    const ui_ratingLabel = document.getElementById("ui_ratingLabel");
    const ui_commentLabel = document.getElementById("ui_commentLabel");

    const ui_coverLabel = document.getElementById("ui_coverLabel");
    const ui_coverHint = document.getElementById("ui_coverHint");

    const ui_listTitle = document.getElementById("ui_listTitle");
    const ui_totalPill = document.getElementById("ui_totalPill");
    const ui_readPill = document.getElementById("ui_readPill");
    const ui_unreadPill = document.getElementById("ui_unreadPill");

    const ui_searchLabel = document.getElementById("ui_searchLabel");
    const ui_filterLabel = document.getElementById("ui_filterLabel");
    const ui_storageHint = document.getElementById("ui_storageHint");

    const ui_th_cover = document.getElementById("ui_th_cover");
    const ui_th_title = document.getElementById("ui_th_title");
    const ui_th_author = document.getElementById("ui_th_author");
    const ui_th_status = document.getElementById("ui_th_status");
    const ui_th_rating = document.getElementById("ui_th_rating");
    const ui_th_comment = document.getElementById("ui_th_comment");
    const ui_th_actions = document.getElementById("ui_th_actions");

    // ====== HELPERS ======
    function showMsg(el, type, text){
      el.innerHTML = `<div class="msg ${type}">${text}</div>`;
    }
    function clearMsg(el){ el.innerHTML = ""; }

    function escapeHtml(s){
      return (s ?? "").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // Username rules:
    // - trim then length >= 4
    // - contains at least 1 uppercase A-Z
    function isValidUsername(u){
      if(!u) return false;
      const s = u.trim();
      if(s.length < 4) return false;
      if(!/[A-Z]/.test(s)) return false;
      return true;
    }

    function userKeyPart(u){
      return encodeURIComponent(u.trim());
    }

    function getStorageKey(){
      if(!currentUser) return null;
      return STORAGE_PREFIX + userKeyPart(currentUser);
    }

    function loadItems(){
      const key = getStorageKey();
      if(!key) return [];
      try {
        const raw = localStorage.getItem(key);
        return raw ? JSON.parse(raw) : [];
      } catch (e){
        return [];
      }
    }
    function saveItems(items){
      const key = getStorageKey();
      if(!key) return;
      localStorage.setItem(key, JSON.stringify(items));
    }

    function starsText(n){
      const filled = "‚òÖ".repeat(n);
      const empty = "‚òÜ".repeat(5-n);
      return filled + empty;
    }

    function updateSummary(items){
      const total = items.length;
      const read = items.filter(x => x.read).length;
      const unread = total - read;
      sumTotal.textContent = total;
      sumRead.textContent = read;
      sumUnread.textContent = unread;
    }

    function refreshModePillAndSaveBtn(){
      if(editId){
        modePill.innerHTML = tf("modeEdit").replace(":", ": <b>").replace(/$/, "</b>").replace(": <b>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</b>","‡πÇ‡∏´‡∏°‡∏î: <b>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</b>");
        // Safer: build explicitly
        modePill.innerHTML = (currentLang === "en-US")
          ? `Mode: <b>Edit</b>`
          : `‡πÇ‡∏´‡∏°‡∏î: <b>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</b>`;
        btnSave.textContent = tf("update");
      } else {
        modePill.innerHTML = (currentLang === "en-US")
          ? `Mode: <b>Add new</b>`
          : `‡πÇ‡∏´‡∏°‡∏î: <b>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</b>`;
        btnSave.textContent = tf("save");
      }
      btnSave.classList.add("ok");
    }

    function setModeAdd(){
      editId = null;
      refreshModePillAndSaveBtn();
    }
    function setModeEdit(){
      refreshModePillAndSaveBtn();
    }

    function resetForm(){
      bookTitle.value = "";
      bookAuthor.value = "";
      readAlready.checked = false;
      comment.value = "";
      setRating(0);
      bookTitle.dataset.isbn = "";
      clearCover();
      clearMsg(saveMsg);
      setModeAdd();
      syncReadStateUI();
    }

    // ====== STARS UI ======
    function buildStars(){
      starBar.innerHTML = "";
      for(let i=1;i<=5;i++){
        const span = document.createElement("span");
        span.className = "star";
        span.textContent = "‚òÖ";
        span.title = `${i}`;
        span.addEventListener("click", () => setRating(i));
        starBar.appendChild(span);
      }
      paintStars();
    }
    function setRating(n){
      rating = n;
      paintStars();
    }
    function paintStars(){
      const stars = [...starBar.querySelectorAll(".star")];
      stars.forEach((s, idx) => s.classList.toggle("active", idx < rating));
      starValue.textContent = `${rating}/5`;
    }

    // ====== unread => disable rating/comment ======
    function syncReadStateUI(){
      const isRead = readAlready.checked;

      starBar.style.pointerEvents = isRead ? "auto" : "none";
      starBar.style.opacity = isRead ? "1" : "0.45";
      starValue.style.opacity = isRead ? "1" : "0.75";
      ratingHint.textContent = isRead ? "" : tf("ratingHintUnread");

      comment.disabled = !isRead;
      comment.placeholder = isRead ? tf("commentPhRead") : tf("commentPhUnread");

      if(!isRead){
        setRating(0);
        comment.value = "";
      }
    }

    readAlready.addEventListener("change", () => {
      syncReadStateUI();
      clearMsg(saveMsg);
    });

    // ====== SEARCH + FILTER ======
    function getFilteredItems(items){
      const q = searchBox.value.trim().toLowerCase();
      const sf = statusFilter.value; // all/read/unread
      return items.filter(it => {
        const statusOk =
          sf === "all" ? true :
          sf === "read" ? !!it.read :
          sf === "unread" ? !it.read : true;

        if(!statusOk) return false;
        if(!q) return true;

        const blob = `${it.title} ${it.author} ${it.comment ?? ""} ${it.isbn ?? ""}`.toLowerCase();
        return blob.includes(q);
      });
    }

    // ====== TABLE RENDER ======
    function renderTable(){
      if(!currentUser){
        bookTable.innerHTML = "";
        return;
      }

      const items = loadItems();
      updateSummary(items);

      const view = getFilteredItems(items);

      if(view.length === 0){
        bookTable.innerHTML = `<tr><td colspan="7" class="muted">${escapeHtml(tf("noResults"))}</td></tr>`;
        return;
      }

      bookTable.innerHTML = view.map((it) => {
        const statusPill = it.read
          ? `<span class="pill ok">${escapeHtml(tf("statusRead"))}</span>`
          : `<span class="pill todo">${escapeHtml(tf("statusUnread"))}</span>`;

        const coverCell = it.coverDataUrl
          ? `<img class="cover-preview" src="${it.coverDataUrl}" alt="cover">`
          : `<div class="cover-preview" style="display:flex;align-items:center;justify-content:center;color:rgba(238,242,255,.55);font-size:12px;">${escapeHtml(tf("noCover"))}</div>`;

        const isbnLine = it.isbn ? `<div class="small">${escapeHtml(tf("isbn"))} ${escapeHtml(it.isbn)}</div>` : "";
        const timeLabel = it.updatedAt ? tf("updated") : tf("created");
        const timeValue = it.updatedAt ? it.updatedAt : it.createdAt;
        const timeLine = `<div class="small">${escapeHtml(timeLabel)} ${escapeHtml(new Date(timeValue).toLocaleString())}</div>`;

        const ratingCell = it.read
          ? `${escapeHtml(starsText(it.rating))}<div class="small">${escapeHtml(String(it.rating))}/5</div>`
          : `${escapeHtml(tf("dash"))}<div class="small">${escapeHtml(tf("ratingNA"))}</div>`;

        const commentCell = it.read
          ? escapeHtml(it.comment || "")
          : `<span class="small">${escapeHtml(tf("dash"))}</span>`;

        return `
          <tr>
            <td>${coverCell}</td>
            <td><b>${escapeHtml(it.title)}</b>${isbnLine}${timeLine}</td>
            <td>${escapeHtml(it.author)}</td>
            <td>${statusPill}</td>
            <td>${ratingCell}</td>
            <td>${commentCell}</td>
            <td class="right">
              <div class="inline" style="justify-content:flex-end;">
                <button class="btn secondary" onclick="editRow('${it.id}')">${escapeHtml(tf("actionEdit"))}</button>
                <button class="btn secondary" onclick="toggleRead('${it.id}')">${escapeHtml(tf("actionToggle"))}</button>
                <button class="btn danger" onclick="deleteRow('${it.id}')">${escapeHtml(tf("actionDelete"))}</button>
              </div>
            </td>
          </tr>
        `;
      }).join("");
    }

    // expose to window
    window.deleteRow = function(id){
      const items = loadItems();
      const next = items.filter(x => x.id !== id);
      saveItems(next);
      if(editId === id) resetForm();
      renderTable();
    };

    // if toggled to unread => clear rating/comment
    window.toggleRead = function(id){
      const items = loadItems();
      const idx = items.findIndex(x => x.id === id);
      if(idx < 0) return;

      items[idx].read = !items[idx].read;

      if(!items[idx].read){
        items[idx].rating = 0;
        items[idx].comment = "";
      }

      items[idx].updatedAt = new Date().toISOString();
      saveItems(items);

      if(editId === id){
        readAlready.checked = !!items[idx].read;
        if(!items[idx].read){
          setRating(0);
          comment.value = "";
        }
        syncReadStateUI();
      }

      renderTable();
    };

    window.editRow = function(id){
      const items = loadItems();
      const it = items.find(x => x.id === id);
      if(!it) return;

      editId = id;
      refreshModePillAndSaveBtn();
      clearMsg(saveMsg);

      bookTitle.value = it.title || "";
      bookAuthor.value = it.author || "";
      readAlready.checked = !!it.read;

      setRating(Number(it.read ? (it.rating || 0) : 0));
      comment.value = it.read ? (it.comment || "") : "";

      bookTitle.dataset.isbn = it.isbn || "";

      currentCoverDataUrl = it.coverDataUrl || null;
      paintCoverPreview();

      syncReadStateUI();
      window.scrollTo({ top: 0, behavior: "smooth" });
    };

    // ====== COVER UPLOAD ======
    function paintCoverPreview(){
      if(currentCoverDataUrl){
        coverPreview.src = currentCoverDataUrl;
        coverPreview.style.visibility = "visible";
      } else {
        coverPreview.removeAttribute("src");
        coverPreview.style.visibility = "hidden";
      }
    }

    function clearCover(){
      currentCoverDataUrl = null;
      coverFile.value = "";
      paintCoverPreview();
    }

    btnRemoveCover.addEventListener("click", clearCover);

    coverFile.addEventListener("change", async (e) => {
      const file = e.target.files?.[0];
      if(!file) return;

      if(file.size > 800 * 1024){
        showMsg(saveMsg, "err", tf("errCoverTooBig"));
        coverFile.value = "";
        return;
      }

      const dataUrl = await fileToDataURL(file);
      currentCoverDataUrl = dataUrl;
      paintCoverPreview();
      showMsg(saveMsg, "ok", tf("msgCoverUploaded"));
    });

    function fileToDataURL(file){
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(r.result);
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    // ====== LOGIN FLOW (username only) ======
    function gotoApp(){
      pageLogin.style.display = "none";
      pageApp.style.display = "block";
      who.textContent = currentUser;
      renderTable();
      resetForm();
    }

    function gotoLogin(){
      pageApp.style.display = "none";
      pageLogin.style.display = "block";
      stopScan();
      currentUser = null;
      resetForm();
    }

    btnLogin.addEventListener("click", () => {
      const u = username.value.trim();

      if(!u){
        showMsg(loginMsg, "err", tf("errNeedUsername"));
        return;
      }
      if(!isValidUsername(u)){
        showMsg(loginMsg, "err", tf("errUsernameRule"));
        return;
      }

      currentUser = u;
      clearMsg(loginMsg);
      gotoApp();
    });

    btnLogout.addEventListener("click", () => {
      gotoLogin();
      showMsg(loginMsg, "ok", tf("msgLoggedOut"));
    });

    // ====== SAVE / UPDATE BOOK ======
    btnSave.addEventListener("click", () => {
      const title = bookTitle.value.trim();
      const author = bookAuthor.value.trim();

      if(!title || !author){
        showMsg(saveMsg, "err", tf("errNeedTitleAuthor"));
        return;
      }

      // rule:
      // - read: rating required
      // - unread: rating/comment not required (force empty)
      if (readAlready.checked) {
        if (rating === 0) {
          showMsg(saveMsg, "err", tf("errNeedRatingRead"));
          return;
        }
      } else {
        setRating(0);
        comment.value = "";
      }

      const items = loadItems();
      const nowIso = new Date().toISOString();
      const isbn = (bookTitle.dataset.isbn || "").trim() || null;

      const finalRating = readAlready.checked ? rating : 0;
      const finalComment = readAlready.checked ? comment.value.trim() : "";

      if(editId){
        const idx = items.findIndex(x => x.id === editId);
        if(idx < 0){
          showMsg(saveMsg, "err", tf("errEditNotFound"));
          resetForm();
          renderTable();
          return;
        }
        items[idx] = {
          ...items[idx],
          title,
          author,
          read: readAlready.checked,
          rating: finalRating,
          comment: finalComment,
          isbn,
          coverDataUrl: currentCoverDataUrl,
          updatedAt: nowIso
        };
        saveItems(items);
        showMsg(saveMsg, "ok", tf("msgUpdated"));
      } else {
        const newItem = {
          id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2),
          title,
          author,
          read: readAlready.checked,
          rating: finalRating,
          comment: finalComment,
          createdAt: nowIso,
          updatedAt: null,
          isbn,
          coverDataUrl: currentCoverDataUrl
        };
        items.unshift(newItem);
        saveItems(items);
        showMsg(saveMsg, "ok", tf("msgSaved"));
      }

      renderTable();
      resetForm();
    });

    btnClear.addEventListener("click", resetForm);

    btnWipeAll.addEventListener("click", () => {
      const ok = confirm(tf("confirmWipe", { user: currentUser }));
      if(!ok) return;
      const key = getStorageKey();
      if(key) localStorage.removeItem(key);
      renderTable();
      resetForm();
    });

    // ====== EXPORT ======
    function makeExportRows(items){
      const isEN = currentLang === "en-US";
      return items.map(it => {
        if(isEN){
          return {
            "User": currentUser,
            "ID": it.id,
            "Title": it.title,
            "Author": it.author,
            "Read": it.read ? "Yes" : "No",
            "Rating(1-5)": it.read ? it.rating : "",
            "Review": it.read ? (it.comment || "") : "",
            "ISBN": it.isbn || "",
            "Added At": it.createdAt ? new Date(it.createdAt).toLocaleString() : "",
            "Updated At": it.updatedAt ? new Date(it.updatedAt).toLocaleString() : "",
            "Has Cover": it.coverDataUrl ? "Yes" : "No"
          };
        }
        return {
          "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ": currentUser,
          "ID": it.id,
          "‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠": it.title,
          "‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô": it.author,
          "‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß": it.read ? "‡πÉ‡∏ä‡πà" : "‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà",
          "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô(1-5)": it.read ? it.rating : "",
          "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô": it.read ? (it.comment || "") : "",
          "ISBN": it.isbn || "",
          "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°": it.createdAt ? new Date(it.createdAt).toLocaleString() : "",
          "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç": it.updatedAt ? new Date(it.updatedAt).toLocaleString() : "",
          "‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏õ‡∏Å": it.coverDataUrl ? "‡πÉ‡∏ä‡πà" : "‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà"
        };
      });
    }

    btnExportXlsx.addEventListener("click", () => {
      const items = loadItems();
      if(items.length === 0){
        showMsg(saveMsg, "err", tf("errNoExportData"));
        return;
      }
      const rows = makeExportRows(items);
      const ws = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Books");
      XLSX.writeFile(wb, `book_log_${userKeyPart(currentUser)}.xlsx`);
      showMsg(saveMsg, "ok", tf("msgExportXlsxOk"));
    });

    btnExportCsv.addEventListener("click", () => {
      const items = loadItems();
      if(items.length === 0){
        showMsg(saveMsg, "err", tf("errNoExportData"));
        return;
      }
      const rows = makeExportRows(items);
      const ws = XLSX.utils.json_to_sheet(rows);
      const csv = XLSX.utils.sheet_to_csv(ws);

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `book_log_${userKeyPart(currentUser)}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      showMsg(saveMsg, "ok", tf("msgExportCsvOk"));
    });

    // ====== SEARCH/FILTER EVENTS ======
    searchBox.addEventListener("input", renderTable);
    statusFilter.addEventListener("change", renderTable);

    // ====== BARCODE SCAN + LOOKUP (ISBN) ======
    async function lookupIsbn(isbn){
      const clean = (isbn || "").replaceAll(/[^0-9Xx]/g, "");
      if(clean.length < 10) return null;

      const url = `https://openlibrary.org/api/books?bibkeys=ISBN:${encodeURIComponent(clean)}&format=json&jscmd=data`;
      const res = await fetch(url);
      const data = await res.json();
      const key = `ISBN:${clean}`;
      if(!data[key]) return null;

      const title = data[key].title || "";
      const authors = (data[key].authors || []).map(a => a.name).filter(Boolean);
      const author = authors.join(", ");

      if(!title || !author) return null;
      return { title, author, isbn: clean };
    }

    function onScanSuccess(decodedText){
      stopScan();
      showMsg(saveMsg, "ok", escapeHtml(tf("scanGot", { code: decodedText })));

      lookupIsbn(decodedText)
        .then(info => {
          if(!info){
            showMsg(saveMsg, "err", tf("scanNotFound"));
            bookTitle.dataset.isbn = decodedText;
            return;
          }
          bookTitle.value = info.title;
          bookAuthor.value = info.author;
          bookTitle.dataset.isbn = info.isbn;
          showMsg(saveMsg, "ok", tf("scanFilled", { isbn: info.isbn }));
        })
        .catch(() => showMsg(saveMsg, "err", tf("scanFetchErr")));
    }

    async function startScan(){
      if(scanning) return;
      scanning = true;

      scannerWrap.style.display = "block";
      btnStartScan.style.display = "none";
      btnStopScan.style.display = "inline-block";

      clearMsg(saveMsg);

      if(!html5Qr){
        html5Qr = new Html5Qrcode("reader");
      }

      try {
        const devices = await Html5Qrcode.getCameras();
        const cameraId = devices?.[0]?.id;
        if(!cameraId){
          showMsg(saveMsg, "err", tf("camNotFound"));
          scanning = false;
          return;
        }

        await html5Qr.start(
          cameraId,
          { fps: 10, qrbox: { width: 250, height: 250 } },
          (decodedText) => onScanSuccess(decodedText),
          () => {}
        );
        showMsg(saveMsg, "ok", tf("scanning"));
      } catch (e){
        showMsg(saveMsg, "err", tf("camNoPermission"));
        scanning = false;
        btnStartScan.style.display = "inline-block";
        btnStopScan.style.display = "none";
      }
    }

    async function stopScan(){
      if(!html5Qr || !scanning) {
        scannerWrap.style.display = "none";
        btnStartScan.style.display = "inline-block";
        btnStopScan.style.display = "none";
        scanning = false;
        return;
      }
      try { await html5Qr.stop(); } catch(_) {}
      scannerWrap.style.display = "none";
      btnStartScan.style.display = "inline-block";
      btnStopScan.style.display = "none";
      scanning = false;
    }

    btnStartScan.addEventListener("click", startScan);
    btnStopScan.addEventListener("click", stopScan);

    // ====== LANG EVENTS ======
    langSelectLogin.addEventListener("change", (e) => setLang(e.target.value));
    langSelectApp.addEventListener("change", (e) => setLang(e.target.value));

    // ====== INIT ======
    buildStars();
    clearCover();
    setModeAdd();

    // apply saved language + initial UI
    setLang(currentLang);

    // ensure initial placeholders/options are localized
    statusFilter.value = "all";
    renderTable();
    resetForm();
  </script>
</body>
</html>
